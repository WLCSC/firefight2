(function(e,t,n){function u(t,n){this.element=t,this.$element=e(t),this.$itemList=e(u.MENU_TEMPLATE),this.options=e.extend({},o,n),this.reset(),this._defaults=o,this._name=i,this.expression=new RegExp("(?:^|\\b|\\s)"+this.options.token+"([\\w.]*)$"),this.cleanupHandle=null,this.init()}var r=function(e,t){e.text(t.val)},i="sew",s=t.document,o={token:"@",elementFactory:r,values:[],unique:!1,repeat:!0};u.MENU_TEMPLATE="<div class='-sew-list-container' style='display: none; position: absolute;'><ul class='-sew-list'></ul></div>",u.ITEM_TEMPLATE='<li class="-sew-list-item"></li>',u.KEYS=[40,38,13,27,9],u.prototype.init=function(){if(this.options.values.length<1)return;this.$element.bind("keyup",e.proxy(this.onKeyUp,this)).bind("keydown",e.proxy(this.onKeyDown,this)).bind("focus",e.proxy(this.renderElements,this,this.options.values)).bind("blur",e.proxy(this.remove,this))},u.prototype.reset=function(){this.options.unique&&(this.options.values=u.getUniqueElements(this.options.values)),this.index=0,this.matched=!1,this.dontFilter=!1,this.lastFilter=n,this.filtered=this.options.values.slice(0)},u.prototype.next=function(){this.index=(this.index+1)%this.filtered.length,this.hightlightItem()},u.prototype.prev=function(){this.index=(this.index+this.filtered.length-1)%this.filtered.length,this.hightlightItem()},u.prototype.select=function(){this.replace(this.filtered[this.index].val),this.hideList()},u.prototype.remove=function(){this.$itemList.fadeOut("slow"),this.cleanupHandle=t.setTimeout(e.proxy(function(){this.$itemList.remove()},this),1e3)},u.prototype.replace=function(e){var t=this.$element.getCursorPosition(),n=t===1?"":" ",r=this.getText(),i=r.substring(0,t);i=i.replace(this.expression,n+this.options.token+e);var s=r.substring(t,r.length),o=s.match(/^\s/)?"":" ",u=i+o+s;this.setText(u),this.$element.setCursorPosition(i.length+1)},u.prototype.hightlightItem=function(){this.$itemList.find(".-sew-list-item").removeClass("selected");var e=this.$itemList.find(".-sew-list-item").parent(),t=this.filtered[this.index].element.addClass("selected"),n=t.position().top;e.scrollTop(e.scrollTop()+n)},u.prototype.renderElements=function(t){e("body").append(this.$itemList);var n=this.$itemList.find("ul").empty();t.forEach(e.proxy(function(t,r){var i=e(u.ITEM_TEMPLATE);this.options.elementFactory(i,t),t.element=i.appendTo(n).bind("click",e.proxy(this.onItemClick,this,t)).bind("mouseover",e.proxy(this.onItemHover,this,r))},this)),this.index=0,this.hightlightItem()},u.prototype.displayList=function(){if(!this.filtered.length)return;this.$itemList.show();var e=this.$element,t=this.$element.offset(),n=e.getCaretPosition();this.$itemList.css({left:t.left+n.left,top:t.top+n.top})},u.prototype.hideList=function(){this.$itemList.hide(),this.reset()},u.prototype.filterList=function(t){if(t==this.lastFilter)return;this.lastFilter=t,this.$itemList.find(".-sew-list-item").remove();var n=this.options.values,r=this.filtered=n.filter(e.proxy(function(e){var n=new RegExp("\\W*"+this.options.token+e.val+"(\\W|$)");return!this.options.repeat&&this.getText().match(n)?!1:t===""||e.val.toLowerCase().indexOf(t.toLowerCase())>=0||(e.meta||"").toLowerCase().indexOf(t.toLowerCase())>=0},this));r.length?(this.renderElements(r),this.$itemList.show()):this.hideList()},u.getUniqueElements=function(e){var t=[];return e.forEach(function(e){var n=t.map(function(e){return e.val}).indexOf(e.val)>=0;if(n)return;t.push(e)}),t},u.prototype.getText=function(){return this.$element.val()||this.$element.text()},u.prototype.setText=function(t){this.$element.prop("tagName").match(/input|textarea/i)?this.$element.val(t):(t=e("<span>").text(t).html().replace(/\s/g,"&nbsp"),this.$element.html(t))},u.prototype.onKeyUp=function(e){var t=this.$element.getCursorPosition(),n=this.getText().substring(0,t),r=n.match(this.expression);if(!r&&this.matched){this.matched=!1,this.dontFilter=!1,this.hideList();return}r&&!this.matched&&(this.displayList(),this.lastFilter="\n",this.matched=!0),r&&!this.dontFilter&&this.filterList(r[1])},u.prototype.onKeyDown=function(e){var t=this.$itemList.is(":visible");if(!t||u.KEYS.indexOf(e.keyCode)<0)return;switch(e.keyCode){case 9:case 13:this.select();break;case 40:this.next();break;case 38:this.prev();break;case 27:this.$itemList.hide(),this.dontFilter=!0}e.preventDefault()},u.prototype.onItemClick=function(e,n){this.cleanupHandle&&t.clearTimeout(this.cleanupHandle),this.replace(e.val),this.hideList()},u.prototype.onItemHover=function(e,t){this.index=e,this.hightlightItem()},e.fn[i]=function(t){return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new u(this,t))})}})(jQuery,window);